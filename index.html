<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cyber Squid - Final Fix</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
    
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(to bottom, #051020, #000);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 999;
      color: #0ff; text-align: center;
    }
    
    button {
      padding: 20px 60px; font-size: 24px; color: #0ff;
      background: rgba(0, 255, 255, 0.1); border: 3px solid #0ff; border-radius: 50px;
      cursor: pointer; margin-top: 30px; letter-spacing: 2px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    
    #hud {
      position: absolute; top: 20px; left: 20px; color: #0ff;
      font-size: 24px; pointer-events: none; text-shadow: 0 0 5px #0ff;
      display: none; font-weight: bold;
    }
    
    #hp-bar {
        position: absolute; top: 20px; right: 20px;
        font-size: 30px; color: #ff5555; text-shadow: 0 0 5px #f00;
        display: none;
        text-align: right;
    }

    .combo-text {
        position: absolute;
        color: #ffff00;
        font-weight: bold;
        font-size: 24px;
        pointer-events: none;
        animation: floatUp 1s forwards;
        text-shadow: 0 0 10px #ffaa00;
        z-index: 10;
    }
    
    .jackpot-text {
        position: absolute;
        color: #FFD700;
        font-weight: bold;
        font-size: 50px;
        pointer-events: none;
        animation: zoomOut 3s forwards;
        text-shadow: 0 0 30px #ffffff;
        z-index: 20;
        width: 100%;
        text-align: center;
        top: 35%;
    }
    
    .evo-text {
        position: absolute;
        color: #00ffff;
        font-weight: bold;
        font-size: 40px;
        pointer-events: none;
        animation: zoomOut 2s forwards;
        text-shadow: 0 0 20px #ffffff;
        z-index: 20;
        width: 100%;
        text-align: center;
        top: 30%;
    }
    
    @keyframes floatUp {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        50% { transform: translateY(-30px) scale(1.5); opacity: 1; }
        100% { transform: translateY(-60px) scale(1); opacity: 0; }
    }
    
    @keyframes zoomOut {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(2.0); opacity: 0; }
    }
  </style>
</head>
<body>

  <div id="hud">SCORE: <span id="score-val">0</span></div>
  <div id="hp-bar">‚ù§‚ù§‚ù§</div>

  <div id="overlay">
    <h1 style="text-shadow: 0 0 20px #0ff; font-size: 50px; margin-bottom: 0;">Ê∑±Êµ∑ÁÉèË≥ä</h1>
    <p style="color: #0aa; font-size: 20px;">ÂÆåÂÖ®ÈÄ≤Âåñ‰øÆÂæ©Áâà</p>
    <button id="start-btn">ÈñãÂßãÂÜíÈö™</button>
  </div>

<script>
// ==========================================
//  PART 1: ËÅ≤Èü≥Á≥ªÁµ± (‰∫íÊñ•ÈÇèËºØ + Á©©ÂÆöÊñπÊ≥¢)
// ==========================================
let jumpSynth, fallSynth, collectSynth, collisionSynth, levelUpSynth, jackpotSynth, dieSynth;
let isAudioReady = false;
let lastJumpPitch = 600;
let fallTimeoutID = null;
let isFallingSoundPlaying = false;

const noteMap = [
    "C5", "D5", "E5", "G5", "A5",
    "C6", "D6", "E6", "G6", "A6",
    "C7", "E7", "G7"
];

async function initAudio() {
    await Tone.start();
    
    jumpSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.02, decay: 0.3, sustain: 0, release: 0.5 }
    }).toDestination();
    jumpSynth.volume.value = -2;

    fallSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
    }).toDestination();
    fallSynth.volume.value = -5;

    // ‚òÖ ‰øÆÊ≠£ÔºöÊîπÁî® Square (ÊñπÊ≥¢) ‰∏îÈôêÂà∂ÊúÄÂ§ßÁôºËÅ≤Êï∏ ‚òÖ
    // ÊñπÊ≥¢ÁöÑÈüøÂ∫¶ÊúÄÁ©©ÂÆöÔºå‰∏çÊúÉÂõ†ÁÇ∫ÈáçÁñäËÄåËÆäÂ∞è
    collectSynth = new Tone.PolySynth(Tone.Synth, {
        maxPolyphony: 10,
        oscillator: { type: "square" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
    }).toDestination();
    collectSynth.volume.value = -12; // ÊñπÊ≥¢ÂæàÂ§ßËÅ≤ÔºåÊâÄ‰ª•ÈÄôË£°Ë®≠Â∞è‰∏ÄÈªû
    
    levelUpSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sawtooth" },
        envelope: { attack: 0.05, decay: 0.5, sustain: 0.3, release: 1.5 }
    }).toDestination();
    levelUpSynth.volume.value = -8;

    // ‚òÖ Jackpot Ê∫´ÊüîÁâà ‚òÖ
    jackpotSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        // Attack 0.5s (ÈÅ©‰∏≠), Release 1.5 (‰∏çÈÅéÈï∑)
        envelope: { attack: 0.5, decay: 0.5, sustain: 0.5, release: 1.5 }
    }).toDestination();
    jackpotSynth.volume.value = -12;

    collisionSynth = new Tone.FMSynth({
        harmonicity: 3.0, modulationIndex: 10, oscillator: { type: "sine" }, modulation: { type: "square" },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 },
        modulationEnvelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 }
    }).toDestination();
    collisionSynth.volume.value = -2;
    
    dieSynth = new Tone.NoiseSynth({
        noise: { type: "brown" },
        envelope: { attack: 0.01, decay: 0.5, sustain: 0 }
    }).toDestination();
    dieSynth.volume.value = -2;

    isAudioReady = true;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('hp-bar').style.display = 'block';
    startGame();
}

function playJumpSound(power) {
    if (!isAudioReady) return;
    stopFallingSequence();
    let pitch = map(power, 0.0, 1.0, 300, 700);
    lastJumpPitch = pitch;
    
    if (squid && squid.evolutionLevel >= 5) {
        jumpSynth.oscillator.type = "square";
        jumpSynth.volume.value = -12;
    } else {
        jumpSynth.oscillator.type = "sine";
        jumpSynth.volume.value = -2;
    }
    jumpSynth.triggerAttackRelease(pitch, "8n");
}

function playCollectSound(comboIndex) {
    if (!isAudioReady) return;
    let index = (comboIndex % 10);
    let rootNote = noteMap[index];
    let harmNote = noteMap[(index + 2) % noteMap.length];
    collectSynth.triggerAttackRelease([rootNote, harmNote], "16n", undefined, 1);
}

function playLevelUpSound() {
    if (!isAudioReady) return;
    levelUpSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n");
}

function playJackpotSound() {
    if (!isAudioReady) return;
    jackpotSynth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "2n");
}

function playCollisionSound() {
    if (!isAudioReady) return;
    collisionSynth.triggerAttackRelease("C3", "8n");
    collisionSynth.frequency.rampTo("C2", 0.1);
}

function playDieSound() {
    if (!isAudioReady) return;
    dieSynth.triggerAttackRelease("4n");
    collisionSynth.triggerAttackRelease("C2", "2n");
    collisionSynth.frequency.rampTo("C1", 1);
}

function startFallingSequence() {
    if (!isAudioReady || isFallingSoundPlaying) return;
    isFallingSoundPlaying = true;
    let currentPitch = lastJumpPitch;
    let currentGap = 0.15;
    let currentVol = -5;
    
    if (squid && squid.evolutionLevel >= 5) {
        fallSynth.oscillator.type = "square";
        fallSynth.volume.value = -12;
    } else {
        fallSynth.oscillator.type = "sine";
        fallSynth.volume.value = -5;
    }

    function playBeat() {
        if (!isFallingSoundPlaying) return;
        let now = Tone.now();
        fallSynth.triggerAttackRelease(currentPitch, currentGap * 0.8, now, Tone.dbToGain(currentVol));
        currentPitch *= 0.85; currentGap *= 0.8; currentVol -= 2;
        if (currentPitch > 50 && currentGap > 0.02) {
            fallTimeoutID = setTimeout(playBeat, currentGap * 1000);
        } else { isFallingSoundPlaying = false; }
    }
    playBeat();
}
function stopFallingSequence() {
    isFallingSoundPlaying = false;
    if (fallTimeoutID) { clearTimeout(fallTimeoutID); fallTimeoutID = null; }
}

// ==========================================
//  PART 2: ÈÅäÊà≤ÈÇèËºØ (ÈÄ≤Âåñ & ‰∫íÊñ•Èü≥Êïà)
// ==========================================
let squid;
let particles = [];
let stars = [];
let terrain;
let pearls = [];
let gameState = 0;
let score = 0;
let gameSpeed = 3;
let shakeAmount = 0;
let canRestart = false;

let comboCount = 0;
let comboTimer = 0;
const COMBO_TIME_LIMIT = 300;

function setup() {
    createCanvas(windowWidth, windowHeight);
    squid = new TechSquid(width * 0.25, height/2);
    terrain = new CaveTerrain();
    
    let btn = document.getElementById('start-btn');
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); initAudio(); });
    btn.addEventListener('click', initAudio);
    
    noLoop();
}

function startGame() {
    gameState = 1;
    score = 0;
    gameSpeed = 3.5;
    comboCount = 0;
    comboTimer = 0;
    squid.reset(width * 0.25, height/2);
    terrain.reset(true);
    
    pearls = [];
    particles = [];
    stars = [];
    updateHPDisplay();
    loop();
}

function updateHPDisplay() {
    let hp = squid.hp;
    let hpElement = document.getElementById('hp-bar');
    let heartSymbol = "‚ù§";
    let color = "#ff5555";
    
    if (hp > 20) { heartSymbol = "üëë"; color = "#ffd700"; }
    else if (hp > 10) { heartSymbol = "üíõ"; color = "#ffff00"; }
    else if (hp > 5) { heartSymbol = "üíô"; color = "#00ffff"; }

    if (hp > 15) { hpElement.innerText = heartSymbol + " x" + hp; }
    else {
        let str = ""; for(let i=0; i<hp; i++) str += heartSymbol; hpElement.innerText = str;
    }
    hpElement.style.color = color;
    hpElement.style.textShadow = `0 0 5px ${color}`;
}

function showComboText(x, y, count) {
    let el = document.createElement('div');
    el.className = 'combo-text';
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.innerText = count > 1 ? "COMBO x" + count + "!" : "NICE!";
    if(count > 5) el.style.color = "#ff00ff";
    document.body.appendChild(el);
    setTimeout(() => { document.body.removeChild(el); }, 1000);
}

function showEvoText(text) {
    let el = document.createElement('div');
    el.className = 'evo-text';
    el.innerHTML = text;
    document.body.appendChild(el);
    setTimeout(() => { document.body.removeChild(el); }, 2000);
}

function showJackpotText() {
    let el = document.createElement('div');
    el.className = 'jackpot-text';
    el.innerHTML = "JACKPOT!<br>SUPER SQUID MODE!";
    document.body.appendChild(el);
    setTimeout(() => { document.body.removeChild(el); }, 3000);
}

function draw() {
    push();
    if (shakeAmount > 0) {
        translate(random(-shakeAmount, shakeAmount), random(-shakeAmount, shakeAmount));
        shakeAmount *= 0.9;
        if(shakeAmount < 0.5) shakeAmount = 0;
    }
    
    drawBackground();

    if (gameState === 1) {
        gameSpeed += 0.0002;
        
        let hasPearlOnScreen = pearls.some(p => p.pos.x > 0 && p.pos.x < width);
        if (comboCount > 0) {
            if (hasPearlOnScreen) comboTimer--;
            if (comboTimer <= 0) {
                comboCount = 0;
                // Êñ∑ÈÄ£‰∏çÈÄÄÂåñÔºå‰øùÊåÅ evolutionLevel
            }
        }
        
        terrain.update();
        terrain.display();

        if (frameCount % 80 === 0 && random() > 0.2) {
            pearls.push(new Pearl(width, terrain.getCenterY(width)));
        }
        for (let i = pearls.length - 1; i >= 0; i--) {
            let p = pearls[i];
            p.update();
            p.display();
            
            if (p.hits(squid)) {
                comboCount++;
                comboTimer = COMBO_TIME_LIMIT;
                score += 100 + (comboCount * 50);
                
                // 1. ÈÄ≤ÂåñÈÇèËºØ (ÊØè10Á¥öÈÄ≤Âåñ‰∏ÄÊ¨°)
                // ÈÄôË£°Ë¶ÅÁî® floor(comboCount / 10) ‰æÜÊ±∫ÂÆöÊòØÂê¶ÂçáÁ¥ö
                // ‰æãÂ¶Ç combo 9->10Ôºålevel 0->1
                let potentialLevel = floor(comboCount / 10);
                
                // Âè™ÊúâÁï∂„ÄåÊΩõÂú®Á≠âÁ¥ö„ÄçÂ§ßÊñº„ÄåÁï∂ÂâçÁ≠âÁ¥ö„Äç‰∏îÂ∞èÊñºÁ≠âÊñº 5 ÊôÇÊâçÈÄ≤Âåñ
                if (potentialLevel > squid.evolutionLevel && potentialLevel <= 5) {
                    squid.setEvolution(potentialLevel);
                    playLevelUpSound();
                    
                    let names = ["", "ÈÄèÊäΩÈÄ≤Âåñ!", "Ê∞¥ÊØçÈÄ≤Âåñ!", "Êµ∑È¶¨ÈÄ≤Âåñ!", "ÁáàÁ±†È≠öÈÄ≤Âåñ!", "ÈªÉÈáëÈú∏‰∏ª!"];
                    showEvoText(names[potentialLevel]);
                    
                    squid.hp++;
                    updateHPDisplay();
                    for(let k=0; k<20; k++) stars.push(new StarParticle(p.pos.x, p.pos.y));
                }
                
                // 2. Èü≥ÊïàÈÇèËºØ (‰∫íÊñ•)
                // Â¶ÇÊûúÊòØ 10 ÁöÑÂÄçÊï∏ÔºåÊí≠Â§ßÁçéËÅ≤ÔºõÂê¶ÂâáÊí≠Êî∂ÈõÜËÅ≤
                if (comboCount > 0 && comboCount % 10 === 0) {
                    playJackpotSound(); // Âè™Êí≠ÈÄôÂÄã
                    score += 1000;
                    showJackpotText();
                    for(let k=0; k<30; k++) stars.push(new StarParticle(p.pos.x, p.pos.y));
                } else {
                    playCollectSound(comboCount); // Âè™Êí≠ÈÄôÂÄã
                    showComboText(screenPosition(p.pos.x), screenPosition(p.pos.y), comboCount);
                    for(let k=0; k<8; k++) particles.push(new Bubble(p.pos.x, p.pos.y, true));
                }
                
                pearls.splice(i, 1);
            } else if (p.offscreen()) {
                pearls.splice(i, 1);
            }
        }

        squid.update();
        squid.display();
        
        if (squid.vel.y > 2.5 && !isFallingSoundPlaying) {
            startFallingSequence();
        }

        let collision = terrain.checkCollision(squid);
        let obstacleHit = terrain.checkObstacleCollision(squid);

        if (collision.hit || obstacleHit) {
            if (collision.type === 'top') {
                squid.pos.y = collision.limit + squid.size/2 + 2;
                if (squid.vel.y < 0) squid.vel.y *= -0.5;
            } else if (collision.type === 'bottom') {
                squid.pos.y = collision.limit - squid.size/2 - 2;
                if (squid.vel.y > 0) squid.vel.y *= -0.5;
            } else if (obstacleHit) {
                squid.vel.x = -5;
                squid.vel.y = random(-5, 5);
            }

            if (!squid.isInvincible) {
                squid.takeDamage();
                comboCount = 0;
                // ÂèóÂÇ∑‰∏çÈÄÄÂåñ
                shakeAmount = 15;
                playCollisionSound();
                updateHPDisplay();
                
                if (collision.type === 'top') squid.vel.y = 8;
                else if (collision.type === 'bottom') squid.vel.y = -12;
                
                if (squid.hp <= 0) triggerDeath();
            }
        }
        document.getElementById('score-val').innerText = score;

    } else if (gameState === 2) {
        terrain.display();
        squid.updatePhysicsOnly();
        squid.display();
        
        if (squid.pos.y > height + 100) {
            fill(255, 50, 50); textSize(60); textAlign(CENTER, CENTER);
            text("GAME OVER", width/2, height/2 - 20);
            
            if (canRestart) {
                textSize(30); fill(255);
                let alpha = map(sin(frameCount * 0.1), -1, 1, 100, 255);
                fill(255, 255, 255, alpha);
                text("ÈªûÊìäÁï´Èù¢ ÈáçÊñ∞ÈñãÂßã", width/2, height/2 + 60);
            }
        }
    }
    
    if (random() > 0.8) particles.push(new Bubble(width, random(height), false));
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].display();
        if (particles[i].finished()) particles.splice(i, 1);
    }
    for (let i = stars.length - 1; i >= 0; i--) {
        stars[i].update();
        stars[i].display();
        if (stars[i].finished()) stars.splice(i, 1);
    }
    
    if (gameState === 1 && comboCount > 0) {
        let barWidth = map(comboTimer, 0, COMBO_TIME_LIMIT, 0, 200);
        let hasPearlOnScreen = pearls.some(p => p.pos.x > 0 && p.pos.
