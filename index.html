<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cyber Squid (Tone.js Version)</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
    
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 10, 20, 0.9);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 999;
      color: #0ff; text-align: center;
    }
    
    button {
      padding: 15px 40px; font-size: 24px; color: #0ff;
      background: transparent; border: 2px solid #0ff; border-radius: 5px;
      cursor: pointer; margin-top: 20px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    
    #status-bar {
      position: absolute; top: 10px; right: 10px; color: rgba(0,255,255,0.7);
      font-size: 14px; pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="status-bar">Audio Engine: Tone.js</div>

  <div id="overlay">
    <h1 style="text-shadow: 0 0 20px #0ff;">CYBER SQUID</h1>
    <p>Tone.js Procedural Sound</p>
    <button id="start-btn">START DIVE</button>
    <p style="font-size: 12px; margin-top: 15px; opacity: 0.7;">請關閉靜音模式 (Turn off Silent Mode)</p>
  </div>

<script>
// ==========================================
//  PART 1: Tone.js 聲音邏輯 (Bouncing Ball)
// ==========================================
let bounceSynth;
let isAudioReady = false;

async function initAudio() {
    await Tone.start();
    
    // 建立合成器 (簡單的正弦波)
    bounceSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: {
            attack: 0.005,
            decay: 0.1,
            sustain: 0,
            release: 0.1
        }
    }).toDestination();
    
    // 調整音量
    bounceSynth.volume.value = -5;

    isAudioReady = true;
    document.getElementById('overlay').style.display = 'none';
    
    // 開始遊戲迴圈
    startGame();
}

// ★ 核心聲音演算法：遞減的時間間隔 ★
function triggerBouncingSound(power) {
    if (!isAudioReady) return;

    // 根據力道決定：起始頻率(高低) 與 起始間隔(快慢)
    let startPitch = map(power, 0.1, 1.0, 300, 1200);
    let startGap = map(power, 0.1, 1.0, 0.15, 0.4);
    
    let now = Tone.now();
    let currentGap = startGap;
    let currentPitch = startPitch;
    let currentVol = 0; // dB

    // 預排 10 次彈跳
    for (let i = 0; i < 10; i++) {
        // 如果頻率太低或間隔太短就停止
        if (currentPitch < 50 || currentGap < 0.01) break;

        bounceSynth.triggerAttackRelease(
            currentPitch,
            currentGap * 0.8, // 音符長度比間隔短一點
            now,
            Tone.dbToGain(currentVol) // 轉成 Gain
        );

        // 下一次的時間點
        now += currentGap;
        
        // ★ 物理衰減公式 ★
        currentGap *= 0.75;    // 時間變快 (間隔變短)
        currentPitch *= 0.85;  // 音高變低
        currentVol -= 3;       // 音量變小 (-3dB)
    }
}


// ==========================================
//  PART 2: p5.js 遊戲與視覺
// ==========================================
let squid;
let bubbles = [];
let gameState = 0; // 0:Menu, 1:Play, 2:Over
let score = 0;

function setup() {
    createCanvas(windowWidth, windowHeight);
    squid = new TechSquid(width/2, height/2);
    for(let i=0; i<30; i++) bubbles.push(new Bubble());
    
    // 綁定按鈕
    document.getElementById('start-btn').addEventListener('click', initAudio);
    noLoop(); // 等待按鈕點擊
}

function startGame() {
    gameState = 1;
    score = 0;
    squid.reset(width/2, height/2);
    loop();
}

function draw() {
    drawBackground();

    // 背景氣泡
    for (let b of bubbles) {
        b.update();
        b.display();
    }

    if (gameState === 1) {
        squid.update();
        squid.display();
        
        // 邊界檢查 (碰到上下都死)
        if (squid.pos.y > height + 50 || squid.pos.y < -50) {
            gameOver();
        }
        
        // 分數顯示
        score += 0.05;
        fill(255); textSize(20); textAlign(LEFT, TOP);
        text("DEPTH: " + floor(score) + "m", 20, 20);
        
    } else if (gameState === 2) {
        squid.display();
        fill(255, 50, 50); textSize(50); textAlign(CENTER, CENTER);
        text("GAME OVER", width/2, height/2);
        textSize(20); fill(255);
        text("Tap to Retry", width/2, height/2 + 50);
    }
}

function gameOver() {
    gameState = 2;
    // 播放一個失敗音效
    if(isAudioReady) {
        const now = Tone.now();
        const osc = new Tone.Oscillator(150, "sawtooth").toDestination().start(now);
        osc.frequency.rampTo(50, 0.5, now);
        osc.stop(now + 0.5);
    }
}

function mousePressed() {
    if (!isAudioReady) return;

    if (gameState === 1) {
        // 遊戲中：跳躍 + 聲音
        let power = random(0.5, 0.9); // 模擬隨機力度
        squid.jump(power);
        triggerBouncingSound(power); // ★ 呼叫 Tone.js 聲音
    } else if (gameState === 2) {
        // 結束時：重來
        startGame();
    }
    return false;
}

function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
    squid.pos.x = width/2;
}

// 背景漸層
function drawBackground() {
    let ctx = drawingContext;
    let gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, "#050f1e");
    gradient.addColorStop(1, "#000000");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
}

// ==========================================
//  PART 3: 章魚與氣泡類別
// ==========================================
class TechSquid {
    constructor(x, y) {
        this.reset(x, y);
        this.size = 60;
        this.baseColor = color(0, 255, 255);
    }
    
    reset(x, y) {
        this.pos = createVector(x, y);
        this.vel = createVector(0, 0);
        this.gravity = 0.4;
        this.drag = 0.96;
        this.bodyColor = this.baseColor;
        this.squish = 1.0;
        this.tentaclePhase = 0;
        this.eyeSize = 15;
    }
    
    jump(power) {
        this.vel.y = -10 - (power * 2); // 向上跳
        this.squish = 0.7;
        this.bodyColor = color(255, 50, 255);
        this.eyeSize = 25;
        
        // 產生粒子
        for(let i=0; i<8; i++) bubbles.push(new Bubble(this.pos.x, this.pos.y + 30, true));
    }
    
    update() {
        this.vel.y += this.gravity;
        this.vel.mult(this.drag);
        this.pos.add(this.vel);
        
        // 左右限制
        this.pos.x = constrain(this.pos.x, 30, width-30);
        
        // 動畫回復
        this.squish = lerp(this.squish, 1.0 + sin(frameCount*0.1)*0.05, 0.1);
        this.bodyColor = lerpColor(this.bodyColor, this.baseColor, 0.05);
        this.eyeSize = lerp(this.eyeSize, 15, 0.1);
        this.tentaclePhase += 0.1 + abs(this.vel.y)*0.05;
    }
    
    display() {
        push();
        translate(this.pos.x, this.pos.y);
        rotate(this.vel.y * 0.02);
        
        // 觸手
        noFill(); strokeWeight(4);
        for(let i=-2; i<=2; i++) {
            stroke(red(this.bodyColor), green(this.bodyColor), blue(this.bodyColor), 200);
            beginShape();
            for(let j=0; j<10; j++) {
                let wave = sin(this.tentaclePhase + i + j*0.5) * j*2;
                vertex(i*10 + wave - this.vel.x*j*0.5, 30 + j*8);
            }
            endShape();
        }
        
        // 身體
        scale(1, this.squish);
        noStroke(); fill(red(this.bodyColor), green(this.bodyColor), blue(this.bodyColor), 150);
        arc(0, 0, this.size*2, this.size*1.8, PI, TWO_PI);
        rect(-this.size, 0, this.size*2, 10);
        
        // 發光邊框
        noFill(); stroke(this.bodyColor); strokeWeight(2);
        arc(0, 0, this.size*1.8, this.size*1.6, PI, TWO_PI);
        
        // 眼睛
        fill(255); noStroke();
        ellipse(-20, -10, this.eyeSize+5); ellipse(20, -10, this.eyeSize+5);
        fill(0);
        ellipse(-20 + this.vel.x*0.5, -10 + this.vel.y*0.2, 5);
        ellipse(20 + this.vel.x*0.5, -10 + this.vel.y*0.2, 5);
        
        pop();
    }
}

class Bubble {
    constructor(x, y, burst) {
        this.isBurst = burst;
        if(burst) {
            this.pos = createVector(x, y);
            this.size = random(5, 15);
            this.speed = random(3, 8);
            this.alpha = 255;
        } else {
            this.reset();
        }
    }
    reset() {
        this.pos = createVector(random(width), random(height));
        this.size = random(2, 6);
        this.speed = random(0.5, 2);
        this.alpha = random(50, 150);
        this.isBurst = false;
    }
    update() {
        this.pos.y -= this.speed;
        if(this.isBurst) {
            this.size *= 0.9;
            this.alpha -= 10;
            if(this.alpha < 0) this.pos.y = -100;
        } else {
            if(this.pos.y < -10) this.reset();
        }
    }
    display() {
        if(this.alpha <= 0) return;
        noStroke(); fill(200, 255, 255, this.alpha);
        ellipse(this.pos.x, this.pos.y, this.size);
    }
}
</script>
</body>
</html>
